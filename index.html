<!DOCTYPE html>
<html>
<head>
    <title>Tea&O Amazing Race - Firebase Edition</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 500px; width: 100%; border-radius: 15px; }
        .neon-border { border: 2px solid #00f2ff; box-shadow: 0 0 10px #00f2ff; }
        /* Custom scrollbar for leaderboard */
        #leaderboard::-webkit-scrollbar { width: 6px; }
        #leaderboard::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-div-icon div {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 242, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 242, 255, 0); }
        }
    </style>
</head>
<body class="bg-slate-900 text-white p-4 font-sans">

    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-cyan-400 uppercase tracking-widest drop-shadow-lg">Tea&O Amazing Race</h1>
        <p class="text-slate-400 mt-2">Seattle â†’ NYC | Goal: 8,390,000 Steps</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
        <div class="space-y-6">
            <!-- Input Form -->
            <div class="bg-slate-800 p-6 rounded-xl neon-border">
                <h2 class="text-xl font-bold mb-4 text-cyan-300">Log Your Steps</h2>
                <input type="text" id="userName" placeholder="Your Name" class="w-full mb-3 p-3 rounded bg-slate-700 border border-slate-600 text-white focus:outline-none focus:border-cyan-400 transition">
                <input type="number" id="stepCount" placeholder="Steps to Add" class="w-full mb-4 p-3 rounded bg-slate-700 border border-slate-600 text-white focus:outline-none focus:border-cyan-400 transition">
                <button id="submitSteps" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded transition duration-200 uppercase tracking-wide">
                    Update Race
                </button>
                <p id="statusMsg" class="text-center text-xs mt-2 h-4 text-green-400"></p>
            </div>

            <!-- Leaderboard -->
            <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 h-96 flex flex-col">
                <h2 class="text-xl font-bold mb-4 flex justify-between">
                    <span>Leaderboard</span>
                    <span class="text-xs text-slate-400 bg-slate-700 px-2 py-1 rounded">Live</span>
                </h2>
                <div id="leaderboard" class="space-y-2 text-sm overflow-y-auto flex-1 pr-2">
                    <p class="text-slate-500 text-center italic">Connecting to satellite...</p>
                </div>
            </div>
        </div>

        <!-- Map Section -->
        <div class="lg:col-span-2 space-y-4">
            <div id="map" class="z-0"></div>
            
            <div class="bg-slate-800 p-6 rounded-xl flex flex-col md:flex-row justify-between items-center border border-slate-700 shadow-lg">
                <div class="mb-4 md:mb-0">
                    <span class="text-slate-400 block text-xs uppercase tracking-wider">Group Progress</span>
                    <span id="totalMiles" class="text-3xl font-mono text-cyan-300 font-bold">0</span>
                    <span class="text-slate-500 text-sm"> / 4,195 Miles</span>
                </div>
                
                <!-- Progress Bar -->
                <div class="flex-1 mx-6 w-full md:w-auto">
                    <div class="w-full bg-slate-700 rounded-full h-2.5">
                        <div id="progressBar" class="bg-cyan-500 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <div class="text-right">
                    <span class="text-slate-400 block text-xs uppercase tracking-wider">Next Stop</span>
                    <span id="nextStop" class="text-lg font-bold text-white">Seattle</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBscaY5kkaXkea9ZFoMeqYNvmCnVEVeTfs",
          authDomain: "tea-and-o-amazing-race.firebaseapp.com",
          projectId: "tea-and-o-amazing-race",
          storageBucket: "tea-and-o-amazing-race.firebasestorage.app",
          messagingSenderId: "138999611724",
          appId: "1:138999611724:web:2698b10f0cff7b3ea74fe9",
          measurementId: "G-B0KZL6PPC3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const RACERS_COLLECTION = "racers";

        // --- 2. CONSTANTS & ROUTE DATA ---
        const STEPS_PER_MILE = 2000;
        const TOTAL_GOAL_MILES = 4195;
        
        const waypoints = [
            { name: "Seattle", coords: [47.6062, -122.3321] },
            { name: "San Francisco", coords: [37.7749, -122.4194] },
            { name: "Los Angeles", coords: [34.0522, -118.2437] },
            { name: "Las Vegas", coords: [36.1699, -115.1398] },
            { name: "Moab", coords: [38.5733, -109.5498] },
            { name: "Denver", coords: [39.7392, -104.9903] },
            { name: "Chicago", coords: [41.8781, -87.6298] },
            { name: "Philadelphia", coords: [39.9526, -75.1652] },
            { name: "New York City", coords: [40.7128, -74.0060] }
        ];

        // --- 3. LEAFLET MAP SETUP ---
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            maxZoom: 19
        }).addTo(map);

        // Draw Route
        const routeCoords = waypoints.map(wp => wp.coords);
        const routeLine = L.polyline(routeCoords, {
            color: '#00f2ff',
            weight: 4,
            opacity: 0.7,
            dashArray: '10, 10',
            lineCap: 'round'
        }).addTo(map);

        // Group Progress Marker
        const raceIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#00f2ff; width:12px; height:12px; border-radius:50%; box-shadow:0 0 10px #ffffff;'></div>",
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        const progressMarker = L.marker(waypoints[0].coords, {icon: raceIcon}).addTo(map);
        progressMarker.bindPopup("<b>Start Line:</b> Seattle, WA");

        // Add Landmark Circles
        waypoints.forEach(wp => {
            L.circleMarker(wp.coords, {
                radius: 4,
                color: '#334155',
                fillColor: '#94a3b8',
                fillOpacity: 1
            }).addTo(map).bindPopup(wp.name);
        });

        map.fitBounds(routeLine.getBounds(), {padding: [50, 50]});

        // --- 4. MATH & GEO LOGIC ---

        function toRad(value) { return (value * Math.PI) / 180; }

        function getDistKm(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(toRad(lat1)) * Math.cos(toRad(lat2));
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Calculate total route distance in abstract units (using km for ratio calculation)
        const segmentDistances = [];
        let totalRouteDistKm = 0;
        for(let i=0; i<waypoints.length-1; i++) {
            const d = getDistKm(
                waypoints[i].coords[0], waypoints[i].coords[1],
                waypoints[i+1].coords[0], waypoints[i+1].coords[1]
            );
            segmentDistances.push(d);
            totalRouteDistKm += d;
        }

        function updateMapPosition(totalSteps) {
            const totalMiles = totalSteps / STEPS_PER_MILE;
            const percentage = Math.min(totalMiles / TOTAL_GOAL_MILES, 1);
            
            // Update UI Stats
            document.getElementById('totalMiles').innerText = Math.floor(totalMiles).toLocaleString();
            document.getElementById('progressBar').style.width = (percentage * 100) + "%";

            // Find Lat/Lng on Polyline
            const targetDistKm = totalRouteDistKm * percentage;
            let currentDistKm = 0;
            let targetCoords = waypoints[waypoints.length-1].coords;
            let nextCity = "New York City";

            for(let i=0; i<segmentDistances.length; i++) {
                if(currentDistKm + segmentDistances[i] >= targetDistKm) {
                    const remaining = targetDistKm - currentDistKm;
                    const ratio = remaining / segmentDistances[i];
                    
                    const lat1 = waypoints[i].coords[0];
                    const lng1 = waypoints[i].coords[1];
                    const lat2 = waypoints[i+1].coords[0];
                    const lng2 = waypoints[i+1].coords[1];

                    // Linear interpolation
                    const lat = lat1 + (lat2 - lat1) * ratio;
                    const lng = lng1 + (lng2 - lng1) * ratio;
                    
                    targetCoords = [lat, lng];
                    nextCity = waypoints[i+1].name;
                    break;
                }
                currentDistKm += segmentDistances[i];
            }

            // Update Marker
            progressMarker.setLatLng(targetCoords);
            progressMarker.setPopupContent(`<b>Current Location</b><br>${(percentage*100).toFixed(2)}% Complete`);
            
            document.getElementById('nextStop').innerText = nextCity;

            // Auto-pan if view is far away
            if(!map.getBounds().contains(targetCoords)) {
                map.panTo(targetCoords);
            }
        }

        // --- 5. FIREBASE LOGIC ---

        // Listen for Realtime Updates
        onSnapshot(collection(db, RACERS_COLLECTION), (snapshot) => {
            let grandTotalSteps = 0;
            let leaderboardData = [];

            snapshot.forEach((doc) => {
                const data = doc.data();
                grandTotalSteps += (data.steps || 0);
                leaderboardData.push({ id: doc.id, ...data });
            });

            // 1. Update Map
            updateMapPosition(grandTotalSteps);

            // 2. Update Leaderboard
            leaderboardData.sort((a, b) => b.steps - a.steps);
            const lbEl = document.getElementById('leaderboard');
            lbEl.innerHTML = "";

            leaderboardData.forEach((user, index) => {
                const isPodium = index < 3;
                const colorClass = isPodium ? "text-cyan-300 font-bold" : "text-slate-300";
                const rankBadge = isPodium ? "ðŸ‘‘" : `#${index + 1}`;
                
                const html = `
                    <div class="flex justify-between items-center bg-slate-700/50 p-2 rounded hover:bg-slate-700 transition">
                        <div class="flex items-center gap-2">
                            <span class="w-6 text-center text-xs opacity-50">${rankBadge}</span>
                            <span class="${colorClass}">${user.name}</span>
                        </div>
                        <span class="font-mono text-cyan-500/80">${user.steps.toLocaleString()}</span>
                    </div>
                `;
                lbEl.insertAdjacentHTML('beforeend', html);
            });
        });

        // Submit Steps
        document.getElementById('submitSteps').addEventListener('click', async () => {
            const name = document.getElementById('userName').value.trim();
            const steps = parseInt(document.getElementById('stepCount').value);
            const statusEl = document.getElementById('statusMsg');

            if(!name || isNaN(steps) || steps <= 0) {
                alert("Please enter a valid name and step count.");
                return;
            }

            try {
                // Check if user exists to update, or create new
                // For simplicity in this race, we use Name as ID (normalized)
                const userId = name.toLowerCase().replace(/\s+/g, '-');
                const userRef = doc(db, RACERS_COLLECTION, userId);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    await updateDoc(userRef, {
                        steps: increment(steps),
                        lastUpdated: serverTimestamp()
                    });
                } else {
                    await setDoc(userRef, {
                        name: name,
                        steps: steps,
                        joined: serverTimestamp()
                    });
                }

                document.getElementById('stepCount').value = '';
                statusEl.innerText = `Added ${steps} steps for ${name}!`;
                setTimeout(() => statusEl.innerText = '', 3000);

            } catch (error) {
                console.error("Error adding steps: ", error);
                alert("Error connecting to database. Check console.");
            }
        });

    </script>
</body>
</html>
